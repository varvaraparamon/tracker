<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div class="center-container">
        <h2>‚è≥ –í–∞—à —Ñ–∞–π–ª –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</h2>
        <p id="queue-status">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏...</p>
        <div class="loader"></div>
    </div>

    <script>
        const taskId = "{{ task_id }}";
        let polling = true;

        async function pollStatus() {
            if (!polling) return;

            const res = await fetch(`/transcribator/queue_status/${taskId}`);
            const data = await res.json();

            if (data.status === "queued") {
                document.getElementById("queue-status").textContent =
                    `–í—ã –≤ –æ—á–µ—Ä–µ–¥–∏: ${data.position}`;
            } else if (data.status === "processing") {
                document.getElementById("queue-status").textContent = "üîß –û–±—Ä–∞–±–æ—Ç–∫–∞...";
            } else if (data.status === "done") {
                polling = false;

                const downloadUrl = `/transcribator/download/${data.transcript_id}`;
                const viewUrl = `/transcribator/view/${data.transcript_id}`;

                if (data.download) {
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = '';
                    a.click();

                    // –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä
                    setTimeout(() => {
                        window.location.href = viewUrl;
                    }, 1000);
                } else {
                    window.location.href = viewUrl;
                }
            } else if (data.status === "error") {
                polling = false;
                document.getElementById("queue-status").textContent = "–û—à–∏–±–∫–∞: " + data.message;
            }
        }

        setInterval(pollStatus, 3000);
        pollStatus();
    </script>

</body>

</html>
